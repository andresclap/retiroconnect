<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ver perfil</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #e6fff4;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .card {
      background: white;
      border-radius: 24px;
      padding: 2.5rem;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
    }

    .avatar-icon {
      font-size: 60px;
      color: #00b980;
      margin-bottom: 1rem;
    }

    h2 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: #007e65;
    }

    .btn-solicitud {
      padding: 0.9rem 1.4rem;
      font-size: 15px;
      border: none;
      border-radius: 14px;
      background-color: #00b980;
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.4s ease;
    }

    .btn-solicitud:hover {
      opacity: 0.9;
    }

    #respuesta {
      margin-top: 1rem;
      font-size: 0.9rem;
      color: #007e65;
    }

    a {
      display: block;
      margin-top: 1.5rem;
      color: #00b980;
      text-decoration: none;
      font-size: 14px;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="avatar-icon">👤</div>
    <h2 id="nombre">Cargando...</h2>

    <button class="btn-solicitud" id="botonSolicitud" onclick="enviarSolicitud()">
      ➕ Enviar solicitud de amistad
    </button>

    <div id="respuesta"></div>
    <a href="explorar.html">⬅ Volver a explorar</a>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      "https://uenvbpfyjfdwbleenkyj.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlbnZicGZ5amZkd2JsZWVua3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2NTA5MjUsImV4cCI6MjA2NjIyNjkyNX0.23sLCLNvAeRj3apPvgps6nqrVk4Qf7qaBWGyyHqN_qM"
    );

    const params = new URLSearchParams(window.location.search);
    const userId = params.get("id");
    let miUsuario = null;

    async function cargarPerfil() {
      const { data: { user } } = await supabase.auth.getUser();
      miUsuario = user;

      if (!userId || !miUsuario) {
        document.getElementById("nombre").innerText = "Usuario no válido.";
        return;
      }

      if (userId === miUsuario.id) {
        document.querySelector(".card").innerHTML = `
          <h2>👤 Este es tu perfil</h2>
          <p><a href="perfil.html">Haz clic aquí para editarlo</a></p>
        `;
        return;
      }

      const { data: usuario, error } = await supabase
        .from("usuarios")
        .select("*")
        .eq("user_id", userId)
        .single();

      if (error || !usuario) {
        document.getElementById("nombre").innerText = "Error cargando perfil.";
        return;
      }

      document.getElementById("nombre").innerText = usuario.nombre || "Sin nombre";

      const { data: solicitudes } = await supabase
        .from("solicitudes_amigos")
        .select("*")
        .eq("emisor_id", miUsuario.id)
        .eq("receptor_id", userId)
        .eq("estado", "pendiente");

      const yaSolicitado = solicitudes.length > 0;
      const boton = document.getElementById("botonSolicitud");

      if (yaSolicitado) {
        boton.innerText = "✅ Solicitud enviada";
        boton.disabled = true;
        boton.style.backgroundColor = "#ccc";
        boton.style.cursor = "not-allowed";
      }
    }

    async function enviarSolicitud() {
      const { error } = await supabase
        .from("solicitudes_amigos")
        .insert({
          emisor_id: miUsuario.id,
          receptor_id: userId,
          estado: "pendiente",
        });

      const mensaje = document.getElementById("respuesta");
      const boton = document.getElementById("botonSolicitud");

      if (error) {
        mensaje.innerText = "❌ Error al enviar la solicitud.";
      } else {
        mensaje.innerText = "✅ Solicitud enviada correctamente.";
        boton.innerText = "✅ Solicitud enviada";
        boton.disabled = true;
        boton.style.backgroundColor = "#ccc";
        boton.style.cursor = "not-allowed";
      }
    }

    // Animación: cambiar tonos de verde cada segundo
    const verdes = ["#00b980", "#00a86b", "#009e6f", "#007e65"];
    let i = 0;
    setInterval(() => {
      const boton = document.getElementById("botonSolicitud");
      if (boton && !boton.disabled) {
        boton.style.backgroundColor = verdes[i];
        i = (i + 1) % verdes.length;
      }
    }, 1000);

    cargarPerfil();
  </script>
</body>
</html>
