<<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Eventos en el mapa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="eventos.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>üíö Eventos en el Mapa</h1>
  </header>

  <div id="mapa"></div>

  <!-- Bot√≥n flotante para crear evento -->
  <button id="btn-nuevo-evento" title="Crear evento">Ôºã</button>

  <!-- Modal para crear evento -->
  <div id="modal-crear" class="modal-crear oculto">
    <div class="contenido-modal">
      <h2>üìç Crear un Evento</h2>
      <form id="form-evento">
        <label>T√≠tulo del evento</label>
        <input type="text" id="titulo" required>

        <label>Descripci√≥n</label>
        <textarea id="descripcion"></textarea>

        <label>Lugar</label>
        <input type="text" id="lugar" required>

        <label>Fecha y hora</label>
        <input type="datetime-local" id="fecha" required>

        <label>Gusto relacionado</label>
        <select id="gusto" required>
          <option value="">Selecciona un gusto</option>
          <option value="Caf√©">Caf√©</option>
          <option value="Naturaleza">Naturaleza</option>
          <option value="Animales">Animales</option>
          <option value="Lectura">Lectura</option>
          <option value="Ejercicio">Ejercicio</option>
          <option value="Espiritualidad">Espiritualidad</option>
        </select>

        <label>Selecciona ubicaci√≥n:</label>
        <div id="mapa-crear"></div>

        <input type="hidden" id="latitud" />
        <input type="hidden" id="longitud" />

        <button type="submit">Crear Evento</button>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const SUPABASE_URL = "https://uenvbpfyjfdwbleenkyj.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlbnZicGZ5amZkd2JsZWVua3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2NTA5MjUsImV4cCI6MjA2NjIyNjkyNX0.23sLCLNvAeRj3apPvgps6nqrVk4Qf7qaBWGyyHqN_qM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function confirmarAsistencia(eventoId) {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data: evento } = await supabase
        .from("eventos")
        .select("usuarios_confirmados")
        .eq("id", eventoId)
        .single();

      const actualizados = evento.usuarios_confirmados || [];
      if (!actualizados.includes(user.id)) actualizados.push(user.id);

      await supabase
        .from("eventos")
        .update({ usuarios_confirmados: actualizados })
        .eq("id", eventoId);

      alert("‚úÖ Asistencia confirmada.");
    }

    async function cargarEventosYMapa() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data: intereses } = await supabase
        .from("intereses")
        .select("gustos")
        .eq("user_id", user.id)
        .single();

      const gustos = intereses?.gustos || [];

      const { data: eventos } = await supabase.from("eventos").select("*");

      const mapa = L.map('mapa').setView([6.0579, -75.5011], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(mapa);

      const iconoCorazon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/833/833472.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });

      eventos.forEach(e => {
        if (
          Array.isArray(e.gustos_relacionados) &&
          e.gustos_relacionados.some(g => gustos.includes(g)) &&
          !(e.usuarios_confirmados || []).includes(user.id) &&
          e.latitud && e.longitud
        ) {
          const popup = `
            <div style="text-align: left;">
              <strong>${e.nombre}</strong><br/>
              üìç ${e.lugar}<br/>
              üìÖ ${new Date(e.fecha).toLocaleString()}<br/>
              üéØ ${e.gustos_relacionados.join(", ")}<br/>
              <button onclick="confirmarAsistencia('${e.id}')">‚úÖ Confirmar</button>
            </div>
          `;
          L.marker([e.latitud, e.longitud], { icon: iconoCorazon })
            .addTo(mapa)
            .bindPopup(popup);
        }
      });
    }

    cargarEventosYMapa();

    // Modal creaci√≥n
    const modal = document.getElementById("modal-crear");
    const btnCrear = document.getElementById("btn-nuevo-evento");

    btnCrear.addEventListener("click", () => {
      modal.classList.remove("oculto");
      inicializarMapaCrear();
    });

    let marcadorCrear = null;
    function inicializarMapaCrear() {
      const mapaCrear = L.map('mapa-crear').setView([6.0579, -75.5011], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(mapaCrear);

      mapaCrear.on('click', function(e) {
        const { lat, lng } = e.latlng;
        if (marcadorCrear) {
          marcadorCrear.setLatLng([lat, lng]);
        } else {
          marcadorCrear = L.marker([lat, lng]).addTo(mapaCrear);
        }
        document.getElementById("latitud").value = lat;
        document.getElementById("longitud").value = lng;
      });
    }

    document.getElementById("form-evento").addEventListener("submit", async (e) => {
      e.preventDefault();
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert("Inicia sesi√≥n para crear eventos.");

      const titulo = document.getElementById("titulo").value.trim();
      const descripcion = document.getElementById("descripcion").value.trim();
      const lugar = document.getElementById("lugar").value.trim();
      const fecha = document.getElementById("fecha").value;
      const gusto = document.getElementById("gusto").value;
      const latitud = parseFloat(document.getElementById("latitud").value);
      const longitud = parseFloat(document.getElementById("longitud").value);

      if (!latitud || !longitud) return alert("Selecciona ubicaci√≥n en el mapa.");

      const { error } = await supabase.from("eventos").insert([{
        nombre: titulo,
        descripcion: descripcion || null,
        lugar,
        fecha,
        gustos_relacionados: [gusto],
        latitud,
        longitud,
        creado_por: user.id,
        usuarios_confirmados: []
      }]);

      if (error) {
        alert("Error al crear el evento.");
        console.error(error);
      } else {
        alert("‚úÖ ¬°Evento creado con √©xito!");
        location.reload();
      }
    });
  </script>
</body>
</html>
